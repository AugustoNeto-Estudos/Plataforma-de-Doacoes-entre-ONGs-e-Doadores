<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo | SolidariHub</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styleAdmin.css') }}">
</head>
<body>
  {% macro mask_id(id_str, keep_start=2, keep_end=2) -%}
    {%- set s = (id_str|string)|replace('.', '')|replace('-', '')|replace('/', '') -%}
    {%- set n = s|length -%}
    {%- if n <= keep_start + keep_end -%}
      {{ s }}
    {%- else -%}
      {{ s[:keep_start] ~ ('*' * (n - keep_start - keep_end)) ~ s[-keep_end:] }}
    {%- endif -%}
  {%- endmacro %}

  {% macro mask_email(email_str) -%}
    {%- set at_index = email_str.find('@') -%}
    {%- if at_index > 0 -%}
      {%- set local = email_str[:at_index] -%}
      {%- set domain = email_str[at_index+1:] -%}
      {%- set ln = local|length -%}
      {%- if ln <= 2 -%}
        {{ local[0:1] ~ '*'*(ln-1) ~ '@' ~ domain }}
      {%- else -%}
        {{ local[0:1] ~ '*'*(ln-2) ~ local[-1:] ~ '@' ~ domain }}
      {%- endif -%}
    {%- else -%}
      {{ email_str }}
    {%- endif -%}
  {%- endmacro %}

  <a href="/" class="btn-home">‚Üê Voltar para Home</a>

  <div class="container">
    <h1><img src="{{ url_for('static', filename='img/icone-admin.png') }}" class="admin-icon"> Painel Administrativo</h1>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-messages">
          {% for msg in messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- ONGs -->
    <h2 id="ongs"><img src="{{ url_for('static', filename='img/icone-ong.png') }}" class="menu-icon"> ONGs cadastradas</h2>
    <div class="filter-bar">
      <form method="GET" action="#ongs">
        <input type="text" name="busca_ong"
               placeholder="Buscar ONG por nome ou email"
               value="{{ request.args.get('busca_ong','') }}"
               class="input-busca"
               style="background-image:url('static/img/icone-lupa-cinza.png'); background-repeat:no-repeat; background-position:8px center; padding-left:32px;">

        <select name="filtro_ong">
          <option value="">Todos</option>
          <option value="ativa" {% if request.args.get('filtro_ong')=='ativa' %}selected{% endif %}>Ativa</option>
          <option value="inativa" {% if request.args.get('filtro_ong')=='inativa' %}selected{% endif %}>Inativa</option>
          <option value="pendente" {% if request.args.get('filtro_ong')=='pendente' %}selected{% endif %}>Pendente</option>
          <option value="aprovada" {% if request.args.get('filtro_ong')=='aprovada' %}selected{% endif %}>Aprovada</option>
          <option value="recusada" {% if request.args.get('filtro_ong')=='recusada' %}selected{% endif %}>Recusada</option>
        </select>
        <button type="submit" class="btn-amazon">Filtrar</button>
      </form>
    </div>

    {% for ong in ongs %}
      <div class="card">
        <h3>
          {{ ong.nome }} ({{ mask_email(ong.email) }})
          <!-- Bot√£o de consulta CNPJ -->
          <form method="POST" style="display:inline;">
            <input type="hidden" name="acao" value="consultar_cnpj">
            <input type="hidden" name="id" value="{{ ong.CNPJ_ID }}">
            <button type="submit" class="btn-consultar-cnpj">
              <img src="{{ url_for('static', filename='img/icone-consulta-branco.png') }}" alt="Consultar CNPJ" class="icon-cnpj">
              Consultar CNPJ
            </button>
          </form>
        </h3>
        <p>CNPJ: {{ mask_id(ong.CNPJ_ID, 2, 2) }}</p>
        <p class="status-verificacao">
          Status Verifica√ß√£o: 
          {% if ong.status_verificacao == 1 %}Aprovada
          {% elif ong.status_verificacao == 2 %}Recusada
          {% else %}Pendente{% endif %}
        </p>
        <p class="status-conta {{ 'ativa' if ong.status_conta else 'inativa' }}">
          Status Conta: {{ "üü¢ Ativa" if ong.status_conta else "üî¥ Inativa" }}
        </p>

        <form method="POST" class="form-group">
          <input type="hidden" name="id" value="{{ ong.CNPJ_ID }}">
          <div class="btn-row">
            <button name="acao" value="aprovar_ong" class="btn-amazon">
              <img src="{{ url_for('static', filename='img/icone-aprovado.png') }}" class="btn-icon"> Aprovar
            </button>
            <button name="acao" value="pendente_ong" class="btn-secondary">
              <img src="{{ url_for('static', filename='img/icone-ampulheta.png') }}" class="btn-icon"> Pendente
            </button>
            <button name="acao" value="recusar_ong" class="btn-secondary">
              <img src="{{ url_for('static', filename='img/icone-x-azul.png') }}" class="btn-icon"> Recusar
            </button>
          </div>
          <div class="btn-row">
            <button name="acao" value="ativar_ong" class="btn-amazon">
              <img src="{{ url_for('static', filename='img/icone-ativar.png') }}" class="btn-icon"> Ativar Conta
            </button>
            <button name="acao" value="desativar_ong" class="btn-secondary">
              <img src="{{ url_for('static', filename='img/icone-desativar.png') }}" class="btn-icon"> Desativar Conta
            </button>
            <!-- Bot√£o que abre o modal --> 
             <button type="button" class="btn-danger" onclick="abrirModalExcluir('{{ ong.CNPJ_ID }}')"> <img src="{{ url_for('static', filename='img/icone-lixo.png') }}" class="btn-icon"> Excluir ONG </button>
          </div>
        </form>
      </div>
    {% endfor %}

    <!-- Doadores -->
    <h2 id="doadores">
      <img src="{{ url_for('static', filename='img/icone-pessoa.png') }}" class="menu-icon"> Doadores cadastrados
    </h2>
    <div class="filter-bar">
      <form method="GET" action="#doadores">
        <input type="text" name="busca_doador"
               placeholder="Buscar Doador por nome ou email"
               value="{{ request.args.get('busca_doador','') }}"
               class="input-busca"
               style="background-image:url('static/img/icone-lupa-cinza.png'); background-repeat:no-repeat; background-position:8px center; padding-left:32px;">
        <select name="filtro_doador">
          <option value="">Todos</option>
          <option value="ativa" {% if request.args.get('filtro_doador')=='ativa' %}selected{% endif %}>Ativa</option>
          <option value="inativa" {% if request.args.get('filtro_doador')=='inativa' %}selected{% endif %}>Inativa</option>
        </select>
        <button type="submit" class="btn-amazon">Filtrar</button>
      </form>
    </div>

    {% for doador in doadores %}
      <div class="card">
        <h3>{{ doador.nome }} ({{ mask_email(doador.email) }})</h3>
        <p>CPF: {{ mask_id(doador.CPF_ID, 2, 2) }}</p>
                <p class="status-conta {{ 'ativa' if doador.status_conta else 'inativa' }}">
          Status Conta: {{ "üü¢ Ativa" if doador.status_conta else "üî¥ Inativa" }}
        </p>

        <form method="POST" class="form-group">
          <input type="hidden" name="id" value="{{ doador.CPF_ID }}">
          <div class="btn-row">
            <button name="acao" value="ativar_doador" class="btn-amazon">
              <img src="{{ url_for('static', filename='img/icone-ativar.png') }}" class="btn-icon"> Ativar
            </button>
            <button name="acao" value="desativar_doador" class="btn-secondary">
              <img src="{{ url_for('static', filename='img/icone-desativar.png') }}" class="btn-icon"> Desativar
            </button>
            <button type="button" class="btn-danger" onclick="abrirModalExcluirDoador('{{ doador.CPF_ID }}')">
              <img src="{{ url_for('static', filename='img/icone-lixo.png') }}" class="btn-icon"> Excluir
            </button>

          </div>
        </form>
      </div>
    {% endfor %}

      <!-- Itens -->
    <h2 id="itens">
      <img src="{{ url_for('static', filename='img/icone-caixa.png') }}" class="menu-icon"> Itens do Cat√°logo
    </h2>

    <h3><img src="{{ url_for('static', filename='img/icone-mais.png') }}" class="menu-icon"> Cadastrar novo item</h3>
    <form method="POST" class="form-group">
      <input type="text" name="categoria" placeholder="Categoria do item" required>
      <input type="text" name="subcategoria" placeholder="Subcategoria (opcional)">
      <button name="acao" value="inserir_item" class="btn-amazon">
        <img src="{{ url_for('static', filename='img/icone-mais.png') }}" class="btn-icon"> Cadastrar Item
      </button>
    </form>

    {% for item in itens %}
      <div class="card">
        <h3>{{ item.categoria }} - {{ item.subcategoria or "Sem subcategoria" }}</h3>
        <p>ID do Item: {{ item.ID_Item }}</p>

        <form method="POST" class="form-group">
          <input type="hidden" name="id" value="{{ item.ID_Item }}">
          <input type="text" name="nova_categoria" value="{{ item.categoria }}" placeholder="Nova categoria">
          <input type="text" name="nova_subcategoria" value="{{ item.subcategoria }}" placeholder="Nova subcategoria">
          <button name="acao" value="atualizar_item" class="btn-amazon">
            <img src="{{ url_for('static', filename='img/icone-atualizar.png') }}" class="btn-icon"> Atualizar
          </button>
          <button name="acao" value="excluir_item" class="btn-danger">
            <img src="{{ url_for('static', filename='img/icone-lixo.png') }}" class="btn-icon"> Excluir
          </button>
        </form>
      </div>
    {% endfor %}

    
{% if dados_cnpj %}
<div id="modalCNPJ" class="modal">
  <div class="modal-content">
    <span class="close" onclick="document.getElementById('modalCNPJ').style.display='none'">&times;</span>
    <h2>Dados P√∫blicos da Receita Federal</h2>
    <ul class="info-list">
      <li><strong>Raz√£o Social:</strong> {{ dados_cnpj.razao_social }}</li>
      <li><strong>Nome Fantasia:</strong> {{ dados_cnpj.nome_fantasia }}</li>
      <li><strong>Situa√ß√£o Cadastral:</strong> {{ dados_cnpj.descricao_situacao_cadastral }}</li>
      <li><strong>Natureza Jur√≠dica:</strong> {{ dados_cnpj.natureza_juridica }}</li>
      <li><strong>Data de Abertura:</strong> {{ dados_cnpj.data_inicio_atividade }}</li>
      <li><strong>Munic√≠pio:</strong> {{ dados_cnpj.municipio }}</li>
      <li><strong>UF:</strong> {{ dados_cnpj.uf }}</li>
    </ul>
  </div>
</div>
{% endif %}

<script>
  window.onload = function() {
    {% if abrir_modal and dados_cnpj %}
      document.getElementById("modalCNPJ").style.display = "flex";
    {% endif %}
  };
</script>


<div id="modalExcluirONG" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="fecharModalExcluir()">&times;</span>
    <h2>Confirmar exclus√£o</h2>
    <p>‚ö†Ô∏è Esta a√ß√£o ir√° excluir permanentemente a ONG e todos os dados vinculados a ela, como listas, inten√ß√µes de doa√ß√£o e pedidos.</p>
    <form method="POST">
      <input type="hidden" name="id" id="idExcluirONG">
      <input type="hidden" name="acao" value="excluir_ong">
      <button type="submit" class="btn-danger">Confirmar exclus√£o</button>
    </form>
  </div>
</div>

<script>
function abrirModalExcluir(id) {
  document.getElementById("modalExcluirONG").style.display = "flex";
  document.getElementById("idExcluirONG").value = id;
}
function fecharModalExcluir() {
  document.getElementById("modalExcluirONG").style.display = "none";
}
</script>


<div id="modalExcluirDoador" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="fecharModalExcluirDoador()">&times;</span>
    <h2>Confirmar exclus√£o do doador</h2>
    <p>‚ö†Ô∏è Esta a√ß√£o ir√° excluir permanentemente o doador e todos os dados vinculados a ele, como inten√ß√µes de doa√ß√£o, pedidos e feedbacks. Deseja continuar?</p>
    <form method="POST">
      <input type="hidden" name="id" id="idExcluirDoador">
      <input type="hidden" name="acao" value="excluir_doador">
      <button type="submit" class="btn-danger">Sim, excluir permanentemente</button>
      <button type="button" class="btn-secondary" onclick="fecharModalExcluirDoador()">Cancelar</button>
    </form>
  </div>
</div>


<script>
  function abrirModalExcluirDoador(id) {
    document.getElementById("modalExcluirDoador").style.display = "flex";
    document.getElementById("idExcluirDoador").value = id;
  }

  function fecharModalExcluirDoador() {
    document.getElementById("modalExcluirDoador").style.display = "none";
  }
</script>


</div> 
</body>
</html>



  
