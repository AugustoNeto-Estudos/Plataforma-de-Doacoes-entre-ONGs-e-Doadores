<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Listas | SolidariHub</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styleGerenciarListasONG.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
</head>
<body>
  <!-- Botão voltar -->
  <a href="{{ url_for('menu_ong.menu_ong') }}" class="btn-voltar">← Voltar ao Menu ONG</a>

  <div class="container">
    <h1><img src="static/img/icone-campanha.png" class="box-icon"> Minhas Campanhas - {{ ong.nome }}</h1>

    <!-- Mensagens -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-messages">
          {% for msg in messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- Criar nova lista -->
    <div class="card">
      <h2><img src="static/img/icone-mais.png" class="box-icon"> Criar nova Campanha</h2>
      <form method="POST">
        <input type="hidden" name="acao" value="criar_lista">
        <input type="text" name="titulo" placeholder="Título da campanha" required>
        <textarea name="descricao" placeholder="Descrição da campanha" rows="3"></textarea>

        <h4><img src="static/img/icone-caixa.png" class="box-icon"> Escolha os itens do catálogo</h4>
        <select id="item-select" name="item_id" multiple required>
          {% for item in catalogo %}
            <option value="{{ item.ID_Item }}">{{ item.categoria }} - {{ item.subcategoria or "Sem subcategoria" }}</option>
          {% endfor %}
        </select>

        <button type="submit" class="btn-amazon">
          <img src="static/img/icone-mais.png" class="menu-icon"> Criar Campanha
        </button>
      </form>
    </div>

    <!-- Barra de busca/filtro -->
    <form method="GET" class="filter-inline">
      <input type="text" name="busca"
            placeholder="Buscar por título ou descrição"
            value="{{ request.args.get('busca','') }}"
            class="input-busca"
            style="background-image:url('static/img/icone-lupa-cinza.png'); background-repeat:no-repeat; background-position:8px center; padding-left:32px;">
      <select name="filtro_status">
        <option value="">Todos</option>
        <option value="ativa" {% if request.args.get('filtro_status')=='ativa' %}selected{% endif %}>Ativa</option>
        <option value="finalizada" {% if request.args.get('filtro_status')=='finalizada' %}selected{% endif %}>Finalizada</option>
      </select>
      <button type="submit" class="btn-amazon">Filtrar</button>
    </form>

    <!-- Listas -->
    {% for lista in listas %}
      <div class="card">
        <h2>{{ lista.titulo }} {% if not lista.status %}<img src="static/img/icone-check.png" class="menu-icon"> Finalizada{% endif %}</h2>
        <p>
          <img src="static/img/icone-like.png" class="icon-feedback"> {{ lista.likes }}
          <img src="static/img/icone-dislike.png" class="icon-feedback"> {{ lista.dislikes }}
        </p>
        <p><strong>Descrição:</strong> {{ lista.descricao }}</p>
        <p><strong>Data de Criação:</strong> {{ lista.data_criacao }}</p>
        <p><strong>Status:</strong> {{ "Finalizada" if not lista.status else "Ativa" }}</p>

        <!-- Botões lado a lado -->
        <form method="POST" class="form-inline">
          <input type="hidden" name="id_lista" value="{{ lista.ID_Lista }}">
          <div class="linha-alterar">
            <input type="text" name="nova_descricao" placeholder="Nova descrição">
            <button name="acao" value="atualizar_descricao" class="btn-secondary">
              <img src="static/img/icone-alterar.png" class="menu-icon"> Alterar
            </button>
          </div>
          <div class="linha-acoes">
            {% if lista.status %}
              <button name="acao" value="finalizar_lista" class="btn-amazon">
                <img src="static/img/icone-aprovado.png" class="menu-icon"> Finalizar
              </button>
            {% else %}
              <button name="acao" value="reativar_lista" class="btn-secondary">
                <img src="static/img/icone-voltar.png" class="menu-icon"> Reativar
              </button>
            {% endif %}
            <button name="acao" value="excluir_lista" class="btn-danger">
              <img src="static/img/icone-lixo.png" class="menu-icon"> Excluir
            </button>
          </div>
        </form>

        <hr>

        <!-- Itens expansíveis -->
        <h3>Itens da Lista</h3>
        {% set itens_lista = lista.itens or [] %}
        {% for item in itens_lista %}
          <details class="item-expander">
            <summary>
              <strong>{{ mapa_itens[item.ID_Item] }}</strong> — Quantidade atual: {{ item.quantidade_necessaria }}
            </summary>
            <form method="POST" class="form-inline">
              <input type="hidden" name="id_lista" value="{{ lista.ID_Lista }}">
              <input type="hidden" name="id_item" value="{{ item.ID_Item }}">
              <input type="number" name="nova_qtd" value="{{ item.quantidade_necessaria }}" min="1" required>
              <button name="acao" value="atualizar_quantidade" class="btn-amazon">
                <img src="static/img/icone-salvar.png" class="menu-icon"> Salvar
              </button>
            </form>
          </details>
        {% else %}
          <p>⚠️ Nenhum item registrado nesta campanha ainda.</p>
        {% endfor %}

        <!-- Adicionar item -->
        <h4><img src="static/img/icone-caixa-adicionar.png" class="box-icon"> Adicionar novo item</h4>
        <form method="POST" class="form-inline">
          <input type="hidden" name="id_lista" value="{{ lista.ID_Lista }}">
          <select name="id_item" required class="dropdown">
            {% for item in catalogo %}
              <option value="{{ item.ID_Item }}">{{ item.categoria }} - {{ item.subcategoria or "Sem subcategoria" }}</option>
            {% endfor %}
          </select>
          <input type="number" name="quantidade" placeholder="Qtd" min="1" required>
          <button name="acao" value="adicionar_item" class="btn-amazon">
            <img src="static/img/icone-mais.png" class="menu-icon"> Adicionar
          </button>
        </form>
      </div>
    {% endfor %}
  </div>

  <!-- Choices.js -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      new Choices('#item-select', {
        removeItemButton: true,
        searchPlaceholderValue: 'Buscar item...',
        noResultsText: 'Nenhum item encontrado',
        itemSelectText: 'Clique para selecionar'
      });
    });
  </script>
</body>
</html>
