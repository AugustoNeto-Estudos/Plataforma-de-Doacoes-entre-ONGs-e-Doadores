<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Minhas Intenções | SolidariHub</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styleIntencoesDoador.css') }}">
</head>
<body>
  <!-- Botão voltar -->
  <a href="{{ url_for('menu_doador.menu_doador') }}" class="btn-voltar">← Voltar ao Menu Doador</a>

  <div class="container">
    <h1><img src="static/img/icone-intencao-azul.png" alt="Minhas Intenções" class="intencao-icon">
      Minhas Intenções de Doação
    </h1>

    <!-- Mensagens de sucesso/erro -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Filtros -->
    <form method="POST" class="filtros-form">
      <select name="status">
        <option value="Todos" {% if status_selecionado == "Todos" %}selected{% endif %}>
          Todos
        </option>
        <option value="Pendente" {% if status_selecionado == "Pendente" %}selected{% endif %}>
          Pendente
        </option>
        <option value="Aprovado" {% if status_selecionado == "Aprovado" %}selected{% endif %}>
          Aprovado
        </option>
        <option value="Reprovado" {% if status_selecionado == "Reprovado" %}selected{% endif %}>
          Reprovado
        </option>
        <option value="Finalizado" {% if status_selecionado == "Finalizado" %}selected{% endif %}>
          Finalizado
        </option>
      </select>

       <input type="text" name="busca"
            placeholder="Buscar por ONG ou campanha"
            value="{{ busca }}"
            class="input-busca"
            style="background-image:url('static/img/icone-lupa-cinza.png'); background-repeat:no-repeat; background-position:8px center; padding-left:32px;">
      <button type="submit" class="btn-amazon">Filtrar</button>
    </form>

   {% macro render_intencoes(lista, titulo) %}
  {% if lista %}
    <h2>{{ titulo }}</h2>
    {% for i in lista %}
      {% set lista_sel = mapa_listas[i.ID_Lista] %}
      {% set ong = mapa_ongs[i.ID_ONG] %}
      <div class="card">
        <p><strong>Campanha:</strong> {{ lista_sel.titulo }}</p>
        <p><strong>ONG:</strong> {{ ong.nome }}</p>
        <p>
          <strong>Email:</strong>
          <span class="ong-info tooltip">
            {{ ong.email }}
            <span class="tooltiptext">
              Use este email para entrar em contato com a ONG e combinar como será feita a doação e as especificações dos itens.
            </span>
          </span>
          |
          <strong>Contato:</strong>
          <span class="ong-info tooltip">
            {{ ong.contato }}
            <span class="tooltiptext">
              Use este contato para falar diretamente com a ONG e alinhar detalhes da doação.
            </span>
          </span>
        </p>
        <p><strong>Data:</strong> {{ i.data_criacao }}</p>
        <p><strong>Status:</strong> {{ STATUS_MAP[i.status] }}</p>

        <!-- Itens pretendidos sempre visíveis -->
        <h4>Itens pretendidos:</h4>
        {% for item in listar_itens_intencao(i.ID_Intencao) %}
          {% set det = mapa_itens[item.ID_Item] %}
          <p>
            {{ det.categoria }} - {{ det.subcategoria }}: {{ item.quantidade_pretendida }} unidades
            {% if item.observacao %}
            <span class="obs-ong">
              <img src="static/img/icone-observacao.png" alt="Observação" class="menu-icon">
              Observação da ONG: {{ item.observacao }}
            </span>
            {% endif %}
          </p>
        {% endfor %}

        <!-- Ações variam conforme status -->
        {% if i.status == 1 %}
          <div class="acoes-intencao">
            <!-- Botão Confirmar Pedido -->
            <form method="POST" action="{{ url_for('intencoes_doador.confirmar_pedido', id_intencao=i.ID_Intencao) }}">
              <button type="button" class="btn-amazon"
                onclick="abrirModalConfirmar('{{ i.ID_Intencao }}')">
                <img src="static/img/icone-pedido.png" class="pedido-icon"> Confirmar Pedido
              </button>
              <!-- Botão Reprovar -->
              <button type="button" class="btn-danger"
                onclick="abrirModalReprovar('{{ i.ID_Intencao }}')">
                <img src="static/img/icone-reprovado-branco.png" class="pedido-icon"> Reprovar
              </button>
            </form>
          </div>
          
        {% elif i.status == 2 %}
          <p class="info">
            <img src="static/img/icone-reprovado.png" class="menu-icon"> Esta intenção foi reprovada
          </p>

        {% elif i.status == 3 %}
          <a href="{{ url_for('pedidos_doador.pedidos_doador') }}" class="btn-amazon">
            <img src="static/img/icone-pasta.png" alt="Ver Pedido" class="pedido-icon">
            Ver Pedido
          </a>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
  {% endif %}
{% endmacro %}


    <!-- Renderização condicional -->
    {% if status_selecionado == "Todos" %}
      {{ render_intencoes(pendentes, '<img src="static/img/icone-ampulheta.png" class="menu-icon"> Intenções Pendentes' | safe) }}
      {{ render_intencoes(aprovadas, '<img src="static/img/icone-aprovado.png" class="menu-icon"> Intenções Aprovadas' | safe) }}
      {{ render_intencoes(reprovadas, '<img src="static/img/icone-reprovado.png" class="menu-icon"> Intenções Reprovadas' | safe) }}
      {{ render_intencoes(finalizadas, '<img src="static/img/icone-finalizado.png" class="menu-icon"> Intenções Finalizadas' | safe) }}
    {% elif status_selecionado == "Pendente" %}
      {{ render_intencoes(pendentes, '<img src="static/img/icone-ampulheta.png" class="menu-icon"> Intenções Pendentes' | safe) }}
    {% elif status_selecionado == "Aprovado" %}
      {{ render_intencoes(aprovadas, '<img src="static/img/icone-aprovado.png" class="menu-icon"> Intenções Aprovadas' | safe) }}
    {% elif status_selecionado == "Reprovado" %}
      {{ render_intencoes(reprovadas, '<img src="static/img/icone-reprovado.png" class="menu-icon"> Intenções Reprovadas' | safe) }}
    {% elif status_selecionado == "Finalizado" %}
      {{ render_intencoes(finalizadas, '<img src="static/img/icone-finalizado.png" class="menu-icon"> Intenções Finalizadas' | safe) }}
    {% endif %}

    <!-- Modal Confirmar Pedido -->
  <div id="modal-confirmar" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <a href="javascript:void(0)" class="close-x" onclick="fecharModal('modal-confirmar')">×</a>
      <h2><img src="static/img/icone-alerta.png" class="menu-icon"> Confirmar Pedido</h2>
      <p class="warning-text">Ao confirmar, esta intenção será finalizada e transformada em pedido. Tem certeza?</p>
      <form method="POST" id="form-confirmar">
        <button type="submit" class="btn-confirmar">
          <img src="static/img/icone-aprovado-branco.png" class="menu-icon"> Confirmar
        </button>
      </form>
    </div>
  </div>
 
 
  <!-- Modal Reprovar Intenção -->
  <div id="modal-reprovar" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <a href="javascript:void(0)" class="close-x" onclick="fecharModal('modal-reprovar')">×</a>
      <h2><img src="static/img/icone-alerta.png" class="menu-icon"> Reprovar Intenção</h2>
      <p class="warning-text">Tem certeza que deseja reprovar esta intenção? A ONG será notificada.</p>
      <form method="POST" id="form-reprovar">
        <button type="submit" class="btn-cancelar">
          <img src="static/img/icone-reprovado-branco.png" class="menu-icon"> Confirmar Reprova
        </button>
      </form>
    </div>
  </div>
 
  <script>
    function abrirModalConfirmar(idIntencao) {
      const form = document.getElementById("form-confirmar");
      form.action = "/ConfirmarPedido/" + idIntencao;
      document.getElementById("modal-confirmar").style.display = "flex";
    }
    function abrirModalReprovar(idIntencao) {
      const form = document.getElementById("form-reprovar");
      form.action = "/ReprovarIntencao/" + idIntencao;
      document.getElementById("modal-reprovar").style.display = "flex";
    }
    function fecharModal(id) {
      document.getElementById(id).style.display = "none";
    }
  </script>

  </div>
</body>
</html>
